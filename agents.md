# Agent Configuration

このファイルは、Webpage to Markdown拡張機能の開発におけるAIエージェント（Claude Code）の動作を定義します。

## プロジェクト概要

**プロジェクト名**: Webpage to Markdown Extension
**目的**: WebページをMarkdown形式に変換し、保存・管理できるChrome/Edge拡張機能
**技術スタック**: Chrome Extensions Manifest V3, IndexedDB, Anthropic API

## 開発フェーズ

### Phase 1: MVP (最小限動作するバージョン)
- 基本的なChrome拡張機能のセットアップ
- Mozilla Readabilityによるコンテンツ抽出
- Turndown.jsによるMarkdown変換
- シンプルなポップアップUI

**優先度**: 🔴 High
**完了条件**: ユーザーがボタンをクリックして、現在のWebページをMarkdownに変換できる

### Phase 2: ストレージ機能
- IndexedDBの実装（articles, images, translations ストア）
- 画像のダウンロードと保存
- 保存済み記事の一覧表示

**優先度**: 🔴 High
**完了条件**: 変換した記事が永続的に保存され、後で閲覧できる

### Phase 3: エクスポート機能
- JSZipを使ったZIPファイル作成
- Markdown + 画像フォルダのエクスポート
- 単一記事・複数記事の一括エクスポート

**優先度**: 🟡 Medium
**完了条件**: 保存した記事をZIPファイルとしてダウンロードできる

### Phase 4: 翻訳機能
- Anthropic API統合
- 章ごとの翻訳処理
- 翻訳ON/OFFスイッチ
- カスタム翻訳プロンプト設定
- 原文と翻訳の両方を保存

**優先度**: 🟡 Medium
**完了条件**: ユーザーがAPIキーを設定し、記事を日本語に翻訳できる

### Phase 5: UI/UX改善
- より洗練されたポップアップデザイン
- 検索・フィルタリング機能
- タグ付け機能
- プレビュー表示

**優先度**: 🟢 Low
**完了条件**: ユーザーが直感的に操作でき、保存した記事を簡単に見つけられる

### Phase 6: テストと最適化
- 手動テスト（複数のWebサイトで動作確認）
- パフォーマンス最適化
- エラーハンドリングの強化
- ドキュメント作成

**優先度**: 🟡 Medium
**完了条件**: 主要なWebサイトで安定して動作する

### Phase 7: Chrome Web Store公開
- アイコンとスクリーンショットの作成
- プライバシーポリシーの作成
- ストアリスティングの準備
- レビュー申請

**優先度**: 🟢 Low
**完了条件**: Chrome Web Storeで公開され、誰でもインストールできる

## コーディングガイドライン

### 1. ファイル構成
- 各モジュールは単一責任の原則に従う
- `src/modules/` - ビジネスロジック
- `src/popup/` - ユーザーインターフェース
- `src/lib/` - サードパーティライブラリ
- `src/utils/` - 汎用ヘルパー関数

### 2. コーディングスタイル
- **言語**: JavaScript (ES6+)
- **命名規則**:
  - クラス: `PascalCase` (例: `ArticleDB`)
  - 関数: `camelCase` (例: `extractContent`)
  - 定数: `UPPER_SNAKE_CASE` (例: `API_ENDPOINT`)
- **非同期処理**: `async/await` を優先（Promiseチェーンは避ける）
- **エラーハンドリング**: すべての非同期関数で `try-catch` を使用

### 3. Chrome拡張固有のルール
- **Manifest V3**: 必ず最新の仕様に従う
- **Content Security Policy**: インラインスクリプト禁止
- **Permissions**: 必要最小限のみ要求
- **Message Passing**: Content Script ↔ Background ↔ Popup 間の通信は `chrome.runtime.sendMessage` を使用

### 4. IndexedDB使用ルール
- **トランザクション**: 常に適切なモード（`readonly` / `readwrite`）を指定
- **エラーハンドリング**: `onerror` / `onsuccess` を必ず実装
- **インデックス**: 頻繁に検索するフィールドにインデックスを作成

### 5. セキュリティ
- **APIキー**: ハードコード厳禁、Chrome Storage Syncに保存
- **XSS対策**: `innerHTML` は避け、`textContent` を使用
- **サニタイゼーション**: ユーザー入力は必ず検証・サニタイズ

### 6. パフォーマンス
- **画像処理**: 並列ダウンロード数を制限（最大5並列）
- **翻訳API**: レート制限を考慮（セクション間500ms待機）
- **IndexedDB**: 大量データのクエリは `cursor` を使用

## 開発時の注意点

### やるべきこと ✅
- 段階的に開発する（Phase 1 → Phase 7）
- 各Phase完了後にテストする
- コミットメッセージは明確に（例: `Add: Markdown conversion feature`）
- エラーメッセージをユーザーフレンドリーに

### やってはいけないこと ❌
- すべての機能を一度に実装しない
- テストなしで次のPhaseに進まない
- セキュリティを軽視しない
- パフォーマンスを無視しない

## テスト戦略

### 手動テスト対象サイト
1. **ニュースサイト**: CNN, BBC, 日本経済新聞
2. **技術ブログ**: Medium, Dev.to, Qiita
3. **ドキュメント**: MDN, GitHub README
4. **複雑なレイアウト**: Wikipedia, Stack Overflow

### テスト項目
- [ ] コンテンツ抽出の精度
- [ ] Markdown変換の品質
- [ ] 画像ダウンロードの成功率
- [ ] IndexedDB保存・読み込み
- [ ] ZIPエクスポートの正常動作
- [ ] 翻訳機能の品質（原文+翻訳の両方保存）
- [ ] 翻訳ON/OFFスイッチの動作
- [ ] カスタムプロンプトの動作確認

## トラブルシューティング

### よくある問題と解決策

#### 1. Readabilityがコンテンツを抽出できない
**原因**: サイトの構造が複雑、または記事タグがない
**解決策**: ユーザーに手動選択機能を提供（Phase 5で実装）

#### 2. 画像がダウンロードできない
**原因**: CORS制限、または画像URLが相対パス
**解決策**: 絶対URLに変換、CORS対応のヘッダー追加

#### 3. IndexedDBが開けない
**原因**: ブラウザの容量制限、または権限エラー
**解決策**: エラーメッセージを表示し、ユーザーにストレージをクリアするよう促す

#### 4. 翻訳APIエラー
**原因**: APIキー未設定、またはレート制限
**解決策**: 設定画面へのリンクを表示、リトライロジック実装

#### 5. ZIPファイルが破損
**原因**: ArrayBufferの取り扱いミス
**解決策**: データ型を正しく変換（Blob → ArrayBuffer → Uint8Array）

## AI Agent（Claude）へのメッセージ

Claude Code（あなた）がこのプロジェクトを開発する際の指針：

1. **段階的実装**: 必ずPhase 1から順番に実装してください。一度にすべてを作らないでください。
2. **テスト重視**: 各機能を実装したら、必ず動作確認してください。
3. **ユーザー体験**: 開発者目線ではなく、エンドユーザーの使いやすさを最優先してください。
4. **エラーハンドリング**: すべてのエラーケースを想定し、適切なエラーメッセージを表示してください。
5. **ドキュメント**: コードにコメントを適切に追加し、README.mdを充実させてください。
6. **セキュリティ**: APIキーの取り扱いには特に注意してください。
7. **パフォーマンス**: 大きな画像や長文記事でも快適に動作するよう最適化してください。
8. **翻訳機能の実装**:
   - 翻訳ON/OFFスイッチを必ず実装
   - 原文と翻訳を両方保存（別々のフィールド）
   - カスタム翻訳プロンプトを設定可能に

## 次のステップ

現在のフェーズ: **Phase 0 - 計画段階**

次にやること:
1. ✅ `agents.md` 作成（このファイル）
2. ✅ `claude.md` 作成
3. ⏳ プロジェクト構造の作成（ディレクトリ、ファイル）
4. ⏳ Phase 1: MVPの実装開始

---

**最終更新日**: 2026-02-11
**バージョン**: 0.1.0
**ステータス**: 🟡 計画中
